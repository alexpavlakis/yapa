---
title: "Methodology"
output: 
  html_document:
    theme: cerulean
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F, cache = T, resuts = F, fig.align = 'center')
```


Yapa is a simple poll aggregator that estimates state-level support for US presidential candidates by combining state-level polls with prior election results.  

# Model

We model state level support for each presidential candidate in three layers:

1) **Prior**: the results in that state from the previous general election;
2) **Data**: state-level polls, weighted by recency and sample size;
3) **Non-sampling error**: we simulate polling error based on its historical distribution, including correlated errors across states.

Specifically, the number of respondents that support each candidate in each poll $y_{p, c}$ is drawn from the total respondents in that poll $n_p$ at a rate specific to the candidate and the state $\theta_{s, c}$.  The rate parameters are distributed with a candidate-state specific center $\alpha_{c, s}$ and state specific scale $t_s$.  The sum of proportions for each candidate must equal one.  Finally, to simulate true underlying support, we first sample a vector of *biases* for each candidate, then sample support based on each state's rate parameter and the sampled bias.  These simulations are repeated tens of thousands of times.

$$
\begin{align}
y_{p, c} &\sim Binomial(n_p, \theta_{s, c}) \\
\theta_{s, c} &\sim Student\_t(\nu, \alpha_{s, c}, \tau_{s}) \\
\sum_c \theta_s &= 1 
\end{align}
$$

All code and data are available at [github.com/alexpavlakis/yapa](https://github.com/alexpavlakis/yapa).

## Weighting 

Polls tend to contribute more to final inferences if they have a) larger sample sizes and b) are closer to the election. We weight polls by recency according to the exponential decay model:

$$
wt_p = e^\frac{-days\_out_p}{60}
$$

```{r fig.align='center', echo = F}
days <- seq(0, 365, 1)
wt <- exp(-days/60)

par(las = 1, mar = c(4, 4, 1, 1))
plot(days, wt, type = "l", bty = 'n', 
     xlab = "days from election", ylab = "poll weight",
     main = NULL)
```

# Backtesting

To evaluate this model, we simulate potential election results for 2016 based on 2012 state outcomes and 2016 state polls, and compare those to the actual results.  The plot below displays the predictions and 90% uncertain intervals for Clinton's vote share in each state (x axis) with the actual election results (y axis).  94% of actual results fall within the 90% intervals.  This model would have given Trump a ~30% chance of winning the election, and it would have handled the uncertainty in key battleground states much better than other poll aggregators and forecasters.

```{r plot, include = T}
library(tidyverse)
load("../results/ppc16")

# Plot
ppc16 %>%
  ggplot() +
  aes(x = mean, y = dem, xmin = lower, xmax = upper, 
      label = abb, col = dem) + 
  geom_abline(intercept = 0, slope = 1, lty = 2, col = 'darkgrey') +
  geom_point(alpha = 0.8, cex = 0.7) +  
  geom_errorbarh(height = 0, alpha = 0.7, lwd = 0.4) +
  ggrepel::geom_text_repel(size = 3, lwd = 0.4) +
  scale_color_gradient(low = "red", high = "blue") +
  scale_x_continuous(limits = c(0, 1),
                     labels = paste0(seq(0, 100, 25), "%")) +
  scale_y_continuous(limits = c(0, 1),
                     labels = paste0(seq(0, 100, 25), "%")) +
  guides(col = F) +
  theme_minimal() +
  labs(x = "prediction", y = "result",
       title = "Model predictions and election results: 2016") +
  theme(plot.title = element_text(size = 15, face = "bold")) 

```

The table below contains predictions for Clinton's vote share in each state, their lower and upper uncertainty intervals, and the actual result.
```{r table}
ppc16 %>%
  select(state, `lower prediction` = lower,
         prediction = mean, `upper prediction` = upper, 
         result = dem) %>%
  mutate_if(is.numeric, function(x) paste0(round(x*100, 1), "%")) %>%
  DT::datatable(., options = list(scrollX = TRUE, 
                                  scrollY = "200px",
                                  pageLength = 51))

```

