---
title: "yapa"
author: "Alex Pavlakis"
output: 
  html_document:
    theme: cerulean
    toc: true
    toc_float: true
    toc_depth: 4
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = F, message = F, cache = F, fig.align = 'center')
```


```{r data}
library(tidyverse)
load("../results/state_results")
load("../results/state_simulations")
load("../results/p_biden")
load("../results/ec_sims")
load("../results/results_biden")
load("../results/results_trump")
```

# national

```{r topline-ec}
biden <- round(quantile(ec_sims[, 2], c(0.05, 0.95)))
trump <- round(quantile(ec_sims[, 1], c(0.05, 0.95)))
```

Biden is projected to win between `r biden[1]` and `r biden[2]` electoral college votes.  Trump is projected to win between `r trump[1]` and `r trump[2]` electoral college votes (90% uncertainty interval).



```{r ecplot, results = T, fig.width = 10}
data_frame(
  electoral_votes = c(ec_sims[, 1], ec_sims[, 2]),
  candidate = c(rep("Trump", nrow(ec_sims)), rep("Biden", nrow(ec_sims)))
) %>% 
  ggplot() +
  aes(x = electoral_votes, fill = candidate, y = ..density..) +
  geom_histogram(alpha = 0.7, bins = 538,
                 position = "identity") +
  scale_x_continuous(limits = c(0, 538),
                     breaks = c(seq(0, 538, 100), 270)) +
  scale_fill_manual(values = c("blue", "red")) +
  geom_vline(xintercept = 270, lty = 2, col = "black") +
  theme_minimal() +
  labs(x = "electoral college votes", y = NULL, fill = NULL,
       title = "distribution of electoral college votes") +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 15, face = "bold", hjust = .5),
        plot.subtitle = element_text(size = 8),
        panel.grid = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size = 11))

```


# states


```{r stateresults, results = T}
p_biden %>%
  mutate(cat = case_when(p_biden >= 0.9 ~ "Likely Biden",
                         p_biden > 0.7 & p_biden < 0.9 ~ "Lean Biden",
                         p_biden <= 0.1 ~ "Likely Trump",
                         p_biden > 0.1 & p_biden < 0.3 ~ "Lean Trump", 
                         TRUE ~ "Tossup")) %>%
  group_by(cat) %>%
  arrange(p_biden) %>%
  mutate(rank = row_number()) %>%
  ungroup() %>%
  mutate(rank = max(rank) - rank) %>%
  ggplot() +
  aes(x = reorder(cat, p_biden), y = rank, label = state, col = p_biden) +
  geom_text() +
  geom_text(alpha = 0.8, size = 4) +
  scale_x_discrete(position = "top") +
  theme_void() +
  theme(axis.text.x = element_text(size = 12, face = "bold", color = "grey10"),
        axis.text.y = element_blank()) +
  labs(x = NULL, y = NULL) +
  guides(col = F) +
  scale_color_gradient(low = "red",  high = "blue")

```



```{r stateplot, results = T, fig.height = 8, fig.align = 'center'}
results_biden %>%
  ggplot() +
  aes(x = mean, y = reorder(state, mean),
      xmin = lower, xmax = upper) +
  geom_point(col = "blue") +
  geom_errorbarh(height = 0, col = "blue") +
  geom_point(data = results_trump, 
             aes(x = mean, y = state,
                 xmin = lower, xmax = upper),
             col = "red") +
  geom_errorbarh(data = results_trump,
                 aes(x = mean, y = state,
                     xmin = lower, xmax = upper), 
                 height = 0, col = "red") +
  theme_minimal() +
  scale_x_continuous(breaks = seq(0, 1, 0.25),
                     labels = paste0(seq(0, 100, 25), "%")) +
  labs(x = "vote share", y = NULL,
       title = "estimated vote share by state",
       subtitle = paste0("source: state polls via RCP as of ", Sys.Date())) +
  theme(plot.title = element_text(size = 15, face = "bold", hjust = 0.5),
        plot.subtitle = element_text(size = 7),
        axis.text.y = element_text(size = 9))
```



Note that uncertainties at this time are due to a) close races and/or b) few polls.  As more polls become available and election day nears, error bars should shrink and the range of reasonable potential outcomes should narrow.


```{r table}
DT::datatable(state_results, options = list(scrollX = TRUE, 
                                            scrollY = "200px",
                                            pageLength = 51))
```


## state detail

```{r state-detail, results = TRUE}
library(tidyverse)
for(s in sort(state_results$State)) {
  print(
    state_simulations %>%
    filter(state == s) %>%
    ggplot() + 
    aes(x = value, fill = candidate, group = NULL, y = ..density..) +
    geom_histogram(position = "identity", alpha = 0.6, bins = 100) +
    scale_x_continuous(limits = c(0, 1),
                       breaks = seq(0, 1, 0.1),
                       labels = paste0(seq(0, 100, 10), "%")) +
    scale_fill_manual(values = c("blue", "grey", "red")) +
    scale_color_manual(values = c("blue", "grey", "red")) +
    geom_vline(aes(xintercept = mean, col = candidate), lty = 2) +
    theme_minimal() +
    theme(panel.grid.minor = element_blank(),
          axis.text.y = element_blank(),
          axis.title.x = element_text(size = 9),
          legend.position = 'bottom',
          plot.title = element_text(size = 15, face = "bold", hjust = 0.5),
          plot.subtitle = element_text(size = 9)) +
    labs(x = NULL, y = NULL, fill = NULL, col = NULL,
         title = paste(s)) +
    guides(col = FALSE)
  )
}
```
