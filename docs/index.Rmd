---
title: "Yet Another Poll Aggregator"
author: "Alex Pavlakis"
output: 
  html_document:
    theme: cerulean
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = F, message = F, cache = F)
```


```{r data}
library(data.table)
state_results <- fread("../results/state_results.csv")
state_simulations <- fread("../results/state_simulations.csv")
p_biden <- fread("../results/p_biden.csv")
er <- fread("../results/electoral_college_sims.csv")
results_biden <- fread("../results/results_biden.csv")
results_trump <- fread("../results/results_trump.csv")

```

# Topline

```{r topline-ec}
biden <- round(quantile(er$V2, c(0.05, 0.95)))
trump <- round(quantile(er$V1, c(0.05, 0.95)))
```

Biden is forcase to win between `r biden[1]` and `r biden[2]` electoral college votes.  Trump is forecast to win between `r trump[1]` and `r trump[2]` electoral college votes (95% uncertainty interval).


<p align="center">

```{r ecplot, results = T}
data_frame(
  electoral_votes = c(er$V1, er$V2),
  candidate = c(rep("Trump", nrow(er)), rep("Biden", nrow(er)))
) %>% 
  ggplot() +
  aes(x = electoral_votes, fill = candidate, y = ..density..) +
  geom_histogram(alpha = 0.7, bins = 60,
                 position = "identity") +
  scale_x_continuous(limits = c(0, 538),
                     breaks = c(seq(0, 538, 100), 270)) +
  scale_fill_manual(values = c("blue", "red")) +
  theme_minimal() +
  labs(x = "electoral college votes", y = NULL, fill = NULL,
       title = "distribution of electoral college votes") +
  theme(legend.position = "bottom",
        plot.title = element_text(size = 15, face = "bold", hjust = .5),
        plot.subtitle = element_text(size = 8),
        panel.grid = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size = 11))

```
</p>


# States

```{r stateresults}
biden_likely_winner <- p_biden[p_biden >= 0.9, state]
biden_favored <- p_biden[p_biden > 0.6 & p_biden < 0.9, state]

trump_likely_winner <- p_biden[p_biden < 0.1, state]
trump_favored <- p_biden[p_biden > 0.1 & p_biden < 0.3, state]

tossup <- p_biden[p_biden >= 0.3 & p_biden <= 0.7, state]
```

Biden is likely to win: `r paste(biden_likely_winner, collapse = ", ")`.

Biden is favored to win: `r paste(biden_favored, collapse = ", ")`.



Trump is likely to win: `r paste(trump_likely_winner, collapse = ", ")`.

Trump is favored to win: `r paste(trump_favored, collapse = ", ")`

The outcomes in the following states are uncertain at this time: `r paste(tossup, collapse = ", ")`

Note that uncertainties at this time are due to a) close races and/or b) limited polling data.  As more polls become available and election day nears, the outcome of some states marked uncertain will become clearer.


```{r stateplot, results = T, fig.height = 8, fig.align = 'center'}
results_biden %>%
  ggplot() +
  aes(x = mean, y = reorder(state, mean),
      xmin = lower, xmax = upper) +
  geom_point(col = "blue") +
  geom_errorbarh(height = 0, col = "blue") +
  geom_point(data = results_trump, 
             aes(x = mean, y = state,
                 xmin = lower, xmax = upper),
             col = "red") +
  geom_errorbarh(data = results_trump,
                 aes(x = mean, y = state,
                     xmin = lower, xmax = upper), 
                 height = 0, col = "red") +
  theme_minimal() +
  scale_x_continuous(breaks = seq(0, 1, 0.25),
                     labels = paste0(seq(0, 100, 25), "%")) +
  labs(x = "vote share", y = NULL,
       title = "estimated vote share by state",
       subtitle = paste0("source: state polls via RCP as of ", Sys.Date())) +
  theme(plot.title = element_text(size = 15, face = "bold", hjust = 0.5),
        plot.subtitle = element_text(size = 7),
        axis.text.y = element_text(size = 9))
```


```{r table}
DT::datatable(state_results, options = list(scrollX = TRUE, 
                                            scrollY = "200px",
                                            pageLength = 51))
```


## State detail

```{r state-detail, results = TRUE}
library(tidyverse)
for(s in sort(state_results$State)) {
  print(
    state_simulations %>%
    filter(state == s) %>%
    ggplot() + 
    aes(x = value, fill = candidate, group = NULL, y = ..density..) +
    geom_histogram(position = "identity", alpha = 0.6, bins = 50) +
    scale_x_continuous(limits = c(0, 1),
                       breaks = seq(0, 1, 0.1),
                       labels = paste0(seq(0, 100, 10), "%")) +
    scale_fill_manual(values = c("blue", "grey", "red")) +
    scale_color_manual(values = c("blue", "grey", "red")) +
    geom_vline(aes(xintercept = mean, col = candidate), lty = 2) +
    theme_minimal() +
    theme(panel.grid.minor = element_blank(),
          axis.text.y = element_blank(),
          axis.title.x = element_text(size = 9),
          legend.position = 'bottom',
          plot.title = element_text(size = 15, face = "bold", hjust = 0.5),
          plot.subtitle = element_text(size = 9)) +
    labs(x = NULL, y = NULL, fill = NULL, col = NULL,
         title = paste(s)) +
    guides(col = FALSE)
  )
}
```
